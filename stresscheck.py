# ==============================================================
# ä¸­å¤§ç”Ÿå” ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆåšåŠ´çœ57é …ç›®æº–æ‹ ï¼‰ver4.5b
# ä»•æ§˜ï¼šã‚¢ãƒ—ãƒªè¡¨ç¤ºï¼A4ç¸¦1æšPDFã‚’å®Œå…¨ä¸€è‡´
# ==============================================================

import streamlit as st
import io, numpy as np, matplotlib.pyplot as plt, pandas as pd, textwrap
from datetime import datetime
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.cidfonts import UnicodeCIDFont
from reportlab.lib import colors
from reportlab.platypus import Table, TableStyle
from reportlab.lib.utils import ImageReader

st.set_page_config(page_title="ä¸­å¤§ç”Ÿå”ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯", layout="centered")
plt.rcParams['font.family'] = 'IPAexGothic'
pdfmetrics.registerFont(UnicodeCIDFont("HeiseiMin-W3"))

APP_CAPTION = "åšåŠ´çœã€è·æ¥­æ€§ã‚¹ãƒˆãƒ¬ã‚¹ç°¡æ˜“èª¿æŸ»ç¥¨ï¼ˆ57é …ç›®ï¼‰ã€æº–æ‹ ï¼ä¸­å¤®å¤§å­¦ç”Ÿæ´»å”åŒçµ„åˆã‚»ãƒ«ãƒ•ã‚±ã‚¢ç‰ˆ"
COL = {"A": "#8B0000", "B": "#003366", "C": "#004B23", "D": "#7B3F00"}

# --------------------------------------------------------------
# è¨­å•å®šç¾©
# --------------------------------------------------------------
Q = [
    "è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§ä»•äº‹ãŒã§ãã‚‹ã€‚","ä»•äº‹ã®é‡ãŒå¤šã„ã€‚","æ™‚é–“å†…ã«ä»•äº‹ã‚’çµ‚ãˆã‚‹ã®ãŒé›£ã—ã„ã€‚","ä»•äº‹ã®å†…å®¹ãŒé«˜åº¦ã§ã‚ã‚‹ã€‚",
    "è‡ªåˆ†ã®çŸ¥è­˜ã‚„æŠ€èƒ½ã‚’ä½¿ã†ä»•äº‹ã§ã‚ã‚‹ã€‚","ä»•äº‹ã«å¯¾ã—ã¦è£é‡ãŒã‚ã‚‹ã€‚","è‡ªåˆ†ã®ä»•äº‹ã®å½¹å‰²ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹ã€‚","è‡ªåˆ†ã®ä»•äº‹ãŒçµ„ç¹”ã®ä¸­ã§é‡è¦ã ã¨æ€ã†ã€‚",
    "ä»•äº‹ã®æˆæœãŒå ±ã‚ã‚Œã‚‹ã¨æ„Ÿã˜ã‚‹ã€‚","è·å ´ã®é›°å›²æ°—ãŒè‰¯ã„ã€‚","è·å ´ã®äººé–“é–¢ä¿‚ã§æ°—ã‚’ä½¿ã†ã€‚","ä¸Šå¸ã‹ã‚‰ã®ã‚µãƒãƒ¼ãƒˆãŒå¾—ã‚‰ã‚Œã‚‹ã€‚","åŒåƒšã‹ã‚‰ã®ã‚µãƒãƒ¼ãƒˆãŒå¾—ã‚‰ã‚Œã‚‹ã€‚",
    "ä»•äº‹ä¸Šã®ç›¸è«‡ãŒã§ãã‚‹ç›¸æ‰‹ãŒã„ã‚‹ã€‚","é¡§å®¢ã‚„å–å¼•å…ˆã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã£ã¦ã„ã‚‹ã€‚","è‡ªåˆ†ã®æ„è¦‹ãŒè·å ´ã§å°Šé‡ã•ã‚Œã¦ã„ã‚‹ã€‚","è·å ´ã«è‡ªåˆ†ã®å±…å ´æ‰€ãŒã‚ã‚‹ã€‚",
    "æ´»æ°—ãŒã‚ã‚‹ã€‚","ä»•äº‹ã«é›†ä¸­ã§ãã‚‹ã€‚","æ°—åˆ†ãŒæ™´ã‚Œãªã„ã€‚","ã‚†ã†ã†ã¤ã ã€‚","æ€’ã‚Šã£ã½ã„ã€‚","ã‚¤ãƒ©ã‚¤ãƒ©ã™ã‚‹ã€‚","è½ã¡ç€ã‹ãªã„ã€‚","ä¸å®‰ã ã€‚","çœ ã‚Œãªã„ã€‚",
    "ç–²ã‚Œã‚„ã™ã„ã€‚","ä½“ãŒã ã‚‹ã„ã€‚","é ­ãŒé‡ã„ã€‚","è‚©ã“ã‚Šã‚„è…°ç—›ãŒã‚ã‚‹ã€‚","èƒƒãŒç—›ã„ã€é£Ÿæ¬²ãŒãªã„ã€‚","å‹•æ‚¸ã‚„æ¯è‹¦ã—ã•ãŒã‚ã‚‹ã€‚","æ‰‹è¶³ã®å†·ãˆã€ã—ã³ã‚ŒãŒã‚ã‚‹ã€‚","ã‚ã¾ã„ã‚„ãµã‚‰ã¤ããŒã‚ã‚‹ã€‚",
    "ä½“èª¿ãŒã™ãã‚Œãªã„ã¨æ„Ÿã˜ã‚‹ã€‚","ä»•äº‹ã‚’ã™ã‚‹æ°—åŠ›ãŒå‡ºãªã„ã€‚","é›†ä¸­åŠ›ãŒç¶šã‹ãªã„ã€‚","ç‰©äº‹ã‚’æ¥½ã—ã‚ãªã„ã€‚","è‡ªåˆ†ã‚’è²¬ã‚ã‚‹ã“ã¨ãŒå¤šã„ã€‚","å‘¨ã‚Šã®äººã«å¯¾ã—ã¦èˆˆå‘³ãŒã‚ã‹ãªã„ã€‚",
    "è‡ªåˆ†ã«ã¯ä¾¡å€¤ãŒãªã„ã¨æ„Ÿã˜ã‚‹ã€‚","å°†æ¥ã«å¸Œæœ›ãŒã‚‚ã¦ãªã„ã€‚","çœ ã£ã¦ã‚‚ç–²ã‚ŒãŒã¨ã‚Œãªã„ã€‚","å°ã•ãªã“ã¨ãŒæ°—ã«ãªã‚‹ã€‚","æ¶™ã‚‚ã‚ããªã‚‹ã€‚","ä¼‘æ—¥ã‚‚ç–²ã‚ŒãŒæ®‹ã‚‹ã€‚",
    "ä¸Šå¸ã¯ã‚ãªãŸã®æ„è¦‹ã‚’èã„ã¦ãã‚Œã‚‹ã€‚","ä¸Šå¸ã¯ç›¸è«‡ã«ã®ã£ã¦ãã‚Œã‚‹ã€‚","ä¸Šå¸ã¯å…¬å¹³ã«æ‰±ã£ã¦ãã‚Œã‚‹ã€‚",
    "åŒåƒšã¯å›°ã£ãŸã¨ãåŠ©ã‘ã¦ãã‚Œã‚‹ã€‚","åŒåƒšã¨ã¯æ°—è»½ã«è©±ãŒã§ãã‚‹ã€‚","åŒåƒšã¨å”åŠ›ã—ãªãŒã‚‰ä»•äº‹ãŒã§ãã‚‹ã€‚",
    "å®¶æ—ã‚„å‹äººã¯ã‚ãªãŸã‚’æ”¯ãˆã¦ãã‚Œã‚‹ã€‚","å®¶æ—ã‚„å‹äººã«æ‚©ã¿ã‚’è©±ã›ã‚‹ã€‚","å®¶æ—ã‚„å‹äººã¯ã‚ãªãŸã®ä»•äº‹ã‚’ç†è§£ã—ã¦ãã‚Œã‚‹ã€‚",
    "ç¾åœ¨ã®ä»•äº‹ã«æº€è¶³ã—ã¦ã„ã‚‹ã€‚","ç¾åœ¨ã®ç”Ÿæ´»ã«æº€è¶³ã—ã¦ã„ã‚‹ã€‚"
]

QTYPE = (
    ["A"]*10 + ["C"]*2 + ["A"]*5 + ["B"]*29 + ["C"]*7 + ["D"]*2
)

QTYPE = (["A"]*17 + ["B"]*29 + ["C"]*9 + ["D"]*2)
REV = [
    1,0,0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,
    1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,
    1,1
]
CHOICES = ["1ï¼šãã†ã§ã¯ãªã„","2ï¼šã‚ã¾ã‚Šãã†ã§ã¯ãªã„","3ï¼šã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„","4ï¼šã‚„ã‚„ãã†ã ","5ï¼šãã†ã "]

assert len(Q)==57 and len(QTYPE)==57 and len(REV)==57

# --------------------------------------------------------------
# çŠ¶æ…‹ç®¡ç†
# --------------------------------------------------------------
if "page" not in st.session_state: st.session_state.page = 0
if "ans" not in st.session_state: st.session_state.ans = [None]*57

# --------------------------------------------------------------
# è¨ˆç®—é–¢æ•°
# --------------------------------------------------------------
def norm100(vals):
    if not vals: return 0
    s,n = sum(vals),len(vals)
    return round((s - 1*n)/(5*n - 1*n)*100,1)

def split_scores(ans):
    g={"A":[],"B":[],"C":[],"D":[]}
    for i,x in enumerate(ans):
        if x is None: continue
        v = 6-x if REV[i]==1 else x
        g[QTYPE[i]].append(v)
    return {k:norm100(v) for k,v in g.items()}

def five_level(score):
    if score < 20: return 0
    elif score < 40: return 1
    elif score < 60: return 2
    elif score < 80: return 3
    else: return 4

def hex_to_rgb01(hexv): return tuple(int(hexv[i:i+2],16)/255 for i in (1,3,5))
def wrap_lines(s, width): return textwrap.wrap(s, width=width)

# --------------------------------------------------------------
# è³ªå•ãƒšãƒ¼ã‚¸
# --------------------------------------------------------------
p = st.session_state.page
if p < 57:
    st.subheader(f"Q{p+1}/57")
    st.write(Q[p])
    ch = st.radio("å›ç­”ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š", CHOICES, index=(st.session_state.ans[p]-1) if st.session_state.ans[p] else 0)
    if ch: st.session_state.ans[p] = CHOICES.index(ch)+1
    if st.button("æ¬¡ã¸ â–¶"): st.session_state.page += 1; st.rerun()
    if p>0 and st.button("â—€ å‰ã¸"): st.session_state.page -= 1; st.rerun()

# --------------------------------------------------------------
# çµæœãƒšãƒ¼ã‚¸
# --------------------------------------------------------------
else:
    if any(a is None for a in st.session_state.ans):
        st.error("æœªå›ç­”ãŒã‚ã‚Šã¾ã™ã€‚å…¨57å•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚")
        if st.button("å…¥åŠ›ã«æˆ»ã‚‹"): st.session_state.page = 0; st.rerun()
        st.stop()

    sc = split_scores(st.session_state.ans)
    A,B,C,D = sc["A"],sc["B"],sc["C"],sc["D"]

    st.subheader("è§£æçµæœ")
    st.markdown(f"**ã‚¹ãƒˆãƒ¬ã‚¹è¦å› (A)ï¼š{A:.1f}ã€€åå¿œ(B)ï¼š{B:.1f}ã€€æ”¯æ´(C)ï¼š{C:.1f}ã€€æº€è¶³(D)ï¼š{D:.1f}**")

    # è¡¨
    def dot_row(name, score):
        lv=five_level(score)
        cells=["â—‹" if i==lv else "" for i in range(5)]
        return [name]+cells+[f"{score:.1f}"]
    df=pd.DataFrame(
        [dot_row("ã‚¹ãƒˆãƒ¬ã‚¹ã®è¦å› (A)",A),dot_row("å¿ƒèº«ã®åå¿œ(B)",B),
         dot_row("å‘¨å›²ã®ã‚µãƒãƒ¼ãƒˆ(C)",C),dot_row("æº€è¶³åº¦(D)",D)],
        columns=["åŒºåˆ†","ä½ã„","ã‚„ã‚„ä½ã„","æ™®é€š","ã‚„ã‚„é«˜ã„","é«˜ã„","å¾—ç‚¹"]
    )
    st.dataframe(df, use_container_width=True)

    # PDFãƒœã‚¿ãƒ³
    buf=io.BytesIO()
    c=canvas.Canvas(buf,pagesize=A4)
    W,H=A4; M=57
    c.setFont("HeiseiMin-W3",12)
    c.drawString(M,H-60,"è·æ¥­æ€§ã‚¹ãƒˆãƒ¬ã‚¹ç°¡æ˜“èª¿æŸ»ç¥¨ï¼ˆåšåŠ´çœæº–æ‹ ï¼‰â€” ä¸­å¤§ç”Ÿå”ã‚»ãƒ«ãƒ•ã‚±ã‚¢ç‰ˆ")
    c.line(M,H-65,W-M,H-65)
    c.setFont("HeiseiMin-W3",9)
    c.drawString(M,H-80,f"å®Ÿæ–½æ—¥ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M')}")
    y=H-110
    data=[["åŒºåˆ†","ä½ã„","ã‚„ã‚„ä½ã„","æ™®é€š","ã‚„ã‚„é«˜ã„","é«˜ã„","å¾—ç‚¹"],
          ["A è¦å› ","","","","","","%.1f"%A],
          ["B åå¿œ","","","","","","%.1f"%B],
          ["C æ”¯æ´","","","","","","%.1f"%C],
          ["D æº€è¶³","","","","","","%.1f"%D]]
    table=Table(data,colWidths=[100,44,44,44,44,44,56])
    table.setStyle(TableStyle([("FONT",(0,0),(-1,-1),"HeiseiMin-W3",9),
                               ("GRID",(0,0),(-1,-1),0.4,colors.black)]))
    table.wrapOn(c,W,H)
    table.drawOn(c,M,y-100)
    c.setFont("HeiseiMin-W3",8)
    c.drawString(M,60,"â€»æœ¬ç¥¨ã¯ã‚»ãƒ«ãƒ•ã‚±ã‚¢ã‚’ç›®çš„ã¨ã—ãŸå‚è€ƒè³‡æ–™ã§ã‚ã‚Šã€åŒ»å­¦çš„è¨ºæ–­ãƒ»è¨¼æ˜ã‚’ç¤ºã™ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
    c.drawString(M,48,"ä¸­å¤®å¤§å­¦ç”Ÿæ´»å”åŒçµ„åˆã€€æƒ…å ±é€šä¿¡ãƒãƒ¼ãƒ ")
    c.save(); buf.seek(0)

    st.download_button("ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",buf.getvalue(),
        file_name=f"{datetime.now().strftime('%Y%m%d')}_StressCheck_ChuoU.pdf",
        mime="application/pdf")

    if st.button("ğŸ” ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã™"):
        st.session_state.page=0; st.session_state.ans=[None]*57; st.rerun()
